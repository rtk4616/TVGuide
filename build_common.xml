<?xml version="1.0" encoding="UTF-8"?>

<project name="TVGuide" basedir="." default="compile_release">

    <!-- 系统属性，请不要擅自修改 -->
    <property environment="env"/>
    <!-- 导入工程描述文件 -->
    <property file="project.properties"/>
    <!-- 设置proguard混淆描述文件 --> 
    <property name="proguard.config" location="proguard.cfg"/>
    <!-- 文件编码设置 -->
    <property name="encoding" value="UTF-8"/>
    <!-- 导入android sdk中自带的默认build文件 -->
    <import file="${sdk.dir}/tools/ant/build.xml" />
    <!-- 引入XML助手 -->
    <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask"/>

    <target name="compile_debug">
        <echo>Nothing to do</echo>
    </target>

    <property name="final.out.dir" location=".." />
    
    <target name="compile_release">
        <echo>sdk.dir=${sdk.dir}</echo>
        <echo>market_channels=${market_channels}</echo>
        <echo>basedir=${basedir}</echo>
        <echo>out.absolute.dir=${out.absolute.dir}</echo>
        <echo>ant.project.name=${ant.project.name}</echo>
        <echo>final.out.dir=${final.out.dir}</echo>
        
        <for list="${market_channels}" delimiter="," param="channel">
            <sequential>
                <!-- 清理工程 -->
                <antcall target="clean"/>
                <echo>@{channel}</echo>
                <xmltask source="./AndroidManifest.xml" dest="./AndroidManifest.xml" encoding="utf-8" >
                    <attr path="//manifest/application/meta-data[@android:name='APP_PID']" attr="android:value" value="@{channel}" />
                    <copy path="//manifest/@android:versionCode" property="android.version.code"/>
                    <copy path="//manifest/@android:versionName" property="android.version.name"/>
                </xmltask>
                <echo message="android.version.code=${android.version.code}" />
                <echo message="android.version.name=${android.version.name}" />
                <!-- 开始编译 -->
                <antcall target="release"/>
                <copy file="${out.absolute.dir}/${ant.project.name}-release.apk" tofile="${final.out.dir}/${ant.project.name}_${android.version.name}_@{channel}.apk" overwrite="true"/>
            </sequential>
        </for>
        
    </target>
    
</project>